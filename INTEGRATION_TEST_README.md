# Полноценный интеграционный тест репликации VectorDB

## [SUCCESS] ПРОБЛЕМА РЕШЕНА!

Тесты теперь **работают и выводят подробную информацию** в консоль!

**Что было исправлено:**
- [OK] Исправлены окончания строк (CRLF -> LF) в bash скриптах
- [OK] Скрипты теперь корректно выполняются
- [OK] Добавлен цветной вывод с подробным описанием каждого шага
- [OK] Показывается прогресс выполнения и результаты проверок
- [OK] Автоматическая установка jq для Windows

Я создал честный интеграционный тест репликации, который проверяет то же самое, что и `ShardRebalancerTest.java`, но в реальной системе без моков.

## Файлы теста

- `scripts/integration-test-replication.sh` - **Полный тест** (5-10 минут)
- `scripts/demo-replication-test.sh` - **Демо-версия** (показывает шаги)
- `scripts/README-replication-test.md` - **Подробная документация**

## Что проверяет тест

Тест имитирует **реальный сценарий отказоустойчивости**:

1. **Запуск кластера** - 3 storage ноды + ZooKeeper + Main API
2. **Настройка репликации** - кольцевая репликация (shard1→shard2→shard3→shard1)
3. **Создание данных** - 20 тестовых векторов
4. **Анализ распределения** - определение primary/replica для тестового вектора
5. **Убийство primary ноды** - остановка контейнера с primary данными
6. **Чтение через реплику** - проверка доступности данных
7. **Read repair** - восстановление primary после перезапуска
8. **Проверка целостности** - финальная верификация

## Запуск

```bash
cd scripts

# Демо-версия (безопасно - показывает шаги)
bash demo-replication-test.sh

# Полный тест (осторожно - ~5-10 мин)
bash integration-test-replication.sh
```

## Пример вывода демо-теста:

```
═══════════════════════════════════════════════════════════
  ДЕМО: Интеграционный тест репликации VectorDB
═══════════════════════════════════════════════════════════

==== Шаг 1: Подготовка кластера ====
[SETUP] Запуск ZooKeeper, 3 storage нод и Main API
[WAIT] Ожидание готовности всех сервисов
[OK] Кластер готов

==== Шаг 2: Настройка репликации ====
[CONFIG] Конфигурация кольцевой репликации:
   shard1 → shard2 → shard3 → shard1
[CLEAN] Очистка тестовых данных
[OK] Репликация настроена

[... продолжение с подробным описанием каждого шага ...]

[RESULT] Ключевой результат:
   [OK] Данные остаются доступны после падения primary
   [OK] Система автоматически читает с реплик
   [OK] Read repair восстанавливает данные
```

## Результаты

**Успешный тест доказывает**:
- Данные остаются доступны после падения primary ноды
- Система автоматически читает с реплик
- Read repair восстанавливает данные на primary
- Репликация работает в реальной распределенной среде

## Сравнение с unit-тестами

| Аспект | Unit Tests (ShardRebalancerTest.java) | Integration Test |
|--------|-------------------------------------|------------------|
| Репликация | Моки всех компонентов | Реальные HTTP вызовы |
| Сеть | Нет | Docker контейнеры |
| Состояние | Изолированные тесты | Полная система |
| Read Repair | Моки | Реальная логика |
| Failover | Симуляция | Настоящее падение нод |

## Архитектура

```
ZooKeeper (2181) ← координация
    ↓
Main API (8080) ← клиентский API
    ↓
Storage Nodes:
├── shard1 (8081) → реплики на shard2
├── shard2 (8082) → реплики на shard3
└── shard3 (8083) → реплики на shard1
```

Тест проверяет, что при падении любого shard'а данные остаются доступны через реплики на других шардах.

## Безопасность

⚠️ **Полный тест модифицирует кластер**:
- Останавливает/запускает контейнеры
- Очищает данные
- Изменяет конфигурацию

Для безопасного просмотра используйте демо-версию.
