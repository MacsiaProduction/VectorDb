# ХАСД Практическая работа №3
## Выполнили: 
- Денисова Мария
- Конончук Сергей
- Полухин Максим
## Структура хранения данных на диске в проекте
- Хранение эмбеддингов организовано в KV - RocksDB
- RocksDB основана на концепции LSM-дерева(Log-Structured Merge-Tree). Основная цель LSM-дерева  — обеспечить быстрый доступ к данным по индексу в условиях частых запросов на вставку.
  <img width="2580" height="1700" alt="image" src="https://github.com/user-attachments/assets/ee768ce9-5e62-4a61-80f5-e9af3b306794" />
- Тремя основными конструкциями RocksDB являются memtable, SST-файл и log-файл. Memtable - структура данных в памяти - новые записи вставляются в memtable и, при необходимости, записываются в файл журнала (log-файл). Файл журнала представляет собой последовательно записываемый файл в хранилище. Когда таблица памяти заполняется, она преобразуется в SST-файл, хранящий данные на диске, а соответствующий файл журнала может быть безопасно удален. Данные в SST-файлах сортируются для облегчения поиска ключей. SST-файлы организованы в иерархическую структуру уровней.
- Операция записи -> WAL -> Active MemTable -> (при заполнении) Immutable MemTable -> (компактизация) -> SST Files (L0)
- Запрос на чтение -> Active MemTable -> Immutable MemTable -> SST Files (L0) -> SST Files (L1) -> ... -> SST Files (Ln)
- RocksDB поддерживает несколько типов SST-файлов. По умолчанию используется тип SST-файлов - BlockBasedTable.
- Структура BlockBasedTable:
```  
  <beginning_of_file>
  [data block 1]
  [data block 2]
  ...
  [data block N]
  [meta block 1: filter block]                  
  [meta block 2: index block]
  [meta block 3: compression dictionary block]  
  [meta block 4: range deletion block]          
  [meta block 5: stats block]                   
  ...
  [metaindex block]
  [Footer]                               (fixed size; starts at file_size - sizeof(Footer))
  <end_of_file>
```
- _filter block_ - метаблок для фильтрации. Фильтр может быть единым блоком на весь SST-файл (Full filter), может быть партиционирован на несколько блоков(Partitioned Filter), либо может быть настроен Block-based filter с помощью "FilterPolicy".
- _index block_ - это двоичная структура данных для поиска блока данных, содержащего диапазон, включая ключ поиска. Файл может содержать один индексный блок или список партиционированных индексных блоков.
- _compression dictionary block_ - метаблок содержит словарь, используемый для настройки библиотеки сжатия перед сжатием/распаковкой каждого блока. Его цель - решить фундаментальную проблему алгоритмов сжатия динамических словарей для небольших блоков данных: словарь создается за один проход по блоку, поэтому небольшие блоки данных всегда содержат небольшие и, следовательно, неэффективные словари.
- _range deletion block_ - метаблок содержит диапазоны удалений в файле key-range и seqnum-range. Диапазоны удалений не могут быть встроены в блоки данных вместе с точечными данными, поскольку в этом случае в диапазонах не будет возможности двоичного поиска.
- _stats block_ - "properties" - метаблок содержит набор свойств/параметров. Ключ - это имя свойства/параметра. Значение - это само свойство/параметр.
  
# Benchmark Results
## Полная матрица результатов

| N | Dim | Storage | Write (s) | Read (s) | Size |
|---|-----|---------|-----------|----------|------|
| 100k | 128 | RocksDB | 0.48 | 0.16 | 55.1 MB |
| 100k | 128 | LMDB | 0.22 | 0.07 | 93.4 MB |
| 100k | 128 | SQLite | 0.32 | 0.23 | 55.9 MB |
| 100k | 128 | Redis | 0.74 | 0.48 | 54.0 MB |
| 200k | 128 | RocksDB | 0.95 | 0.52 | 110.3 MB |
| 200k | 128 | LMDB | 0.35 | 0.14 | 144.9 MB |
| 200k | 128 | SQLite | 0.64 | 0.44 | 111.9 MB |
| 200k | 128 | Redis | 1.42 | 1.03 | 109.4 MB |
| 500k | 128 | RocksDB | 2.22 | 1.88 | 393.9 MB |
| 500k | 128 | LMDB | 0.93 | 0.44 | 399.1 MB |
| 500k | 128 | SQLite | 1.43 | 1.09 | 279.7 MB |
| 500k | 128 | Redis | 3.77 | 2.73 | 276.0 MB |
| 1000k | 128 | RocksDB | 4.61 | 4.19 | 776.2 MB |
| 1000k | 128 | LMDB | 2.67 | 1.00 | 947.2 MB |
| 1000k | 128 | SQLite | 3.20 | 2.22 | 559.4 MB |
| 1000k | 128 | Redis | 8.13 | 5.83 | 553.4 MB |
| 100k | 256 | RocksDB | 0.55 | 0.21 | 104.2 MB |
| 100k | 256 | LMDB | 0.18 | 0.07 | 164.0 MB |
| 100k | 256 | SQLite | 0.55 | 0.23 | 130.5 MB |
| 100k | 256 | Redis | 0.73 | 0.47 | 147.1 MB |
| 200k | 256 | RocksDB | 0.97 | 0.52 | 208.6 MB |
| 200k | 256 | LMDB | 0.38 | 0.16 | 249.9 MB |
| 200k | 256 | SQLite | 1.05 | 0.46 | 261.1 MB |
| 200k | 256 | Redis | 1.49 | 1.06 | 294.1 MB |
| 500k | 256 | RocksDB | 2.54 | 1.80 | 547.4 MB |
| 500k | 256 | LMDB | 1.44 | 0.50 | 870.1 MB |
| 500k | 256 | SQLite | 3.20 | 1.18 | 652.7 MB |
| 500k | 256 | Redis | 4.26 | 3.00 | 735.3 MB |
| 1000k | 256 | RocksDB | 4.83 | 4.49 | 1.1 GB |
| 1000k | 256 | LMDB | 3.34 | 1.08 | 1.5 GB |
| 1000k | 256 | SQLite | 7.94 | 2.65 | 1.3 GB |

## Лидеры по чтению

| N | Dim | Лидер | Read (s) | 2-е место | Read (s) |
|---|-----|-------|----------|-----------|----------|
| 100k | 128 | LMDB | 0.07 | RocksDB | 0.16 |
| 200k | 128 | LMDB | 0.14 | SQLite | 0.44 |
| 500k | 128 | LMDB | 0.44 | SQLite | 1.09 |
| 1000k | 128 | LMDB | 1.00 | SQLite | 2.22 |
| 100k | 256 | LMDB | 0.07 | RocksDB | 0.21 |
| 200k | 256 | LMDB | 0.16 | SQLite | 0.46 |
| 500k | 256 | LMDB | 0.50 | SQLite | 1.18 |
| 1000k | 256 | LMDB | 1.08 | SQLite | 2.65 |

## Лидеры по записи

| N | Dim | Лидер | Write (s) | 2-е место | Write (s) |
|---|-----|-------|-----------|-----------|-----------|
| 100k | 128 | LMDB | 0.22 | SQLite | 0.32 |
| 500k | 128 | LMDB | 0.93 | SQLite | 1.43 |
| 1000k | 128 | LMDB | 2.67 | SQLite | 3.20 |
| 1000k | 256 | LMDB | 3.34 | RocksDB | 4.83 |

## Размер на диске (1M записей)

| Storage | dim=128 | dim=256 | Overhead vs SQLite |
|---------|---------|---------|-------------------|
| SQLite | 559.4 MB | 1.3 GB | baseline |
| Redis | 553.4 MB | — | -1% |
| RocksDB | 776.2 MB | 1.1 GB | +39% / -15% |
| LMDB | 947.2 MB | 1.5 GB | +69% / +15% |

## Выводы

| Критерий | Лидер | Комментарий |
|----------|-------|-------------|
| **Скорость чтения** | LMDB | В 4x быстрее RocksDB на 1M записей |
| **Скорость записи** | LMDB | Стабильно лучший |
| **Размер на диске** | SQLite/Redis | LMDB +70% overhead |
| **Стабильность** | LMDB | Линейное масштабирование |

